<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Quickly detect document boundaries from a live camera stream and crop the document out before normalizing it further through perspective correction, deskewing, and more." />
    <meta name="keywords" content="camera based quadrilateral detection and normalization" />
    <title>Detect the boundary of a document and normalize it</title>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-core@3.0.10/dist/core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-document-normalizer@2.0.11/dist/ddn.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-capture-vision-router@2.0.11/dist/cvr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-camera-enhancer@4.0.0/dist/dce.js"></script>
</head>

<body>
    <h1 style="font-size: 1.5em">
        Detect the boundary of a document and normalize it
    </h1>
    <button id="start-detecting" onclick="startDetecting()">
      Start Detecting
    </button>
    <button id="restart-detecting" onclick="restartDetecting()" style="display: none">
      Restart Detecting
    </button>
    <button id="confirm-quad-for-normalization">Confirm the Boundary</button>
    <button id="normalize-with-confirmed-quad" disabled>Normalize</button><br />
    <input type="checkbox" style="vertical-align: middle" id="ipt-checkbox" /><label style="vertical-align: middle" for="ipt-checkbox">Normalize Automatically</label
    >
    <div id="div-ui-container" style="margin-top: 10px; height: 500px"></div>
    <div
      id="div-image-container"
      style="display: none; width: 100vw; height: 70vh"
    ></div>
    <div id="normalized-result"></div>
    <script>
      let quads = [];
      let view = null;
      let cameraEnhancer = null;
      let router = null;
      let items;
      let image;
      let layer;
      let imageEditorView;
      let promiseCVRReady;
      let frameCount = 0;

      const btnStart = document.querySelector("#start-detecting");
      const btnRestart = document.querySelector("#restart-detecting");
      const cameraViewContainer = document.querySelector("#div-ui-container");
      const normalizedImageContainer =
        document.querySelector("#normalized-result");
      const btnEdit = document.querySelector("#confirm-quad-for-normalization");
      const btnNormalize = document.querySelector(
        "#normalize-with-confirmed-quad"
      );
      const imageEditorViewContainer = document.querySelector(
        "#div-image-container"
      );
      const iptCheckbox = document.querySelector("input");

      /** LICENSE ALERT - README
       * To use the library, you need to first call the method initLicense() to initialize the license using a license key string.
       */
      Dynamsoft.License.LicenseManager.initLicense(
        "DLS2eyJvcmdhbml6YXRpb25JRCI6IjIwMDAwMSJ9"
      );
      /**
       * The license "DLS2eyJvcmdhbml6YXRpb25JRCI6IjIwMDAwMSJ9" is a temporary license for testing good for 24 hours.
       * You can visit https://www.dynamsoft.com/customer/license/trialLicense?utm_source=github&architecture=dcv&product=ddn&package=js to get your own trial license good for 30 days.
       * LICENSE ALERT - THE END
       */

      /**
       * Preloads the `DocumentNormalizer` module, saving time in preparing for document border detection and image normalization.
       */
      Dynamsoft.CVR.CaptureVisionRouter.preloadModule(["DDN"]);

      /**
       * Creates a CameraEnhancer instance and prepares an ImageEditorView instance for later use.
       */
      async function initDCE() {
        view = await Dynamsoft.DCE.CameraView.createInstance();
        cameraEnhancer = await Dynamsoft.DCE.CameraEnhancer.createInstance(
          view
        );
        let scanRegion = {
            x: 25,
            y: 25,
            width: 50,
            height: 50,
            isMeasuredInPercentage: true
        };
        cameraEnhancer.setScanRegion(scanRegion); 
        imageEditorView = await Dynamsoft.DCE.ImageEditorView.createInstance(
          imageEditorViewContainer
        );
        /* Creates an image editing layer for drawing found document boundaries. */
        layer = imageEditorView.createDrawingLayer();
      }

      /**
       * Creates a CaptureVisionRouter instance and configure the task to detect document boundaries.
       * Also, make sure the original image is returned after it has been processed.
       */
      let cvrReady = (async function initCVR() {
        await initDCE();
        router = await Dynamsoft.CVR.CaptureVisionRouter.createInstance();
        router.setInput(cameraEnhancer);
        /**
         * Sets the result types to be returned.
         * Because we need to normalize the original image later, here we set the return result type to
         * include both the quadrilateral and original image data.
         */
        let newSettings = await router.getSimplifiedSettings(
          "detect-document-boundaries"
        );
        newSettings.capturedResultItemTypes =
          Dynamsoft.Core.EnumCapturedResultItemType.CRIT_DETECTED_QUAD |
          Dynamsoft.Core.EnumCapturedResultItemType.CRIT_ORIGINAL_IMAGE;
        await router.updateSettings("detect-document-boundaries", newSettings);
        cameraViewContainer.append(view.getUIElement());

        /* Defines the result receiver for the task.*/
        const resultReceiver = new Dynamsoft.CVR.CapturedResultReceiver();
        resultReceiver.onCapturedResultReceived = handleCapturedResult;
        router.addResultReceiver(resultReceiver);
      })();

      /**
       * Defines the callback function that is executed after each image has been processed.
       */
      async function handleCapturedResult(result) {
        /* Do something with the result */
        
        /* Saves the image data of the current frame for subsequent image editing. */
        image = result.items.filter((item) => item.type === 1)[0].imageData;
        if (!iptCheckbox.checked) {
          items = result.items;
        } else {
          /** If "Normalize Automatically" is checked, the library uses the document boundaries found in consecutive
           * image frames to decide whether conditions are suitable for automatic normalization.
           */
          if (result.items.length <= 1) {
            frameCount = 0;
            return;
          }
          frameCount++;
          /**
           * In our case, we determine a good condition for "automatic normalization" to be
           * "getting document boundary detected for 30 consecutive frames".
           *
           * NOTE that this condition will not be valid should you add a CapturedResultFilter
           * with ResultDeduplication enabled.
           */
          if (frameCount === 30) {
            frameCount = 0;
            normalizedImageContainer.innerHTML = "";
            /**
             * When the condition is met, we use the document boundary found in this image frame
             * to normalize the document by setting the coordinates of the ROI (region of interest)
             * in the built-in template "normalize-document".
             */
            let settings = await router.getSimplifiedSettings(
              "normalize-document"
            );
            settings.roiMeasuredInPercentage = 0;
            settings.roi.points = result.items[1].location.points;
            await router.updateSettings("normalize-document", settings);
            /**
             * After that, executes the normalization and shows the result on the page.
             */
            let normalizeResult = await router.capture(
              result.items.filter((item) => item.type === 1)[0].imageData,
              "normalize-document"
            );
            normalizedImageContainer.append(
              normalizeResult.items[0].toCanvas()
            );
            cameraViewContainer.style.display = "none";
            btnStart.style.display = "none";
            btnRestart.style.display = "inline";
            await router.stopCapturing();
          }
        }
      }

      async function startDetecting() {
        try {
          await (promiseCVRReady =
            promiseCVRReady ||
            (async () => {
              await cvrReady;
              /* Starts streaming the video. */
              await cameraEnhancer.open();
              /* Uses the built-in template "detect-document-boundaries" to start a continuous boundary detection task. */
              await router.startCapturing("detect-document-boundaries");
            })());
        } catch (ex) {
          let errMsg;
          if (ex.message.includes("network connection error")) {
            errMsg =
              "Failed to connect to Dynamsoft License Server: network connection error. Check your Internet connection or contact Dynamsoft Support (support@dynamsoft.com) to acquire an offline license.";
          } else {
            errMsg = ex.message || ex;
          }
          console.error(errMsg);
          alert(errMsg);
        }
      }

      async function restartDetecting() {
        /* Reset the UI elements and restart the detection task. */
        imageEditorViewContainer.style.display = "none";
        normalizedImageContainer.innerHTML = "";
        cameraViewContainer.style.display = "block";
        btnStart.style.display = "inline";
        btnRestart.style.display = "none";
        btnNormalize.disabled = true;
        btnEdit.disabled = false;
        layer.clearDrawingItems();

        await router.startCapturing("detect-document-boundaries");
      }

      iptCheckbox.addEventListener("change", () => {
        btnEdit.style.display = iptCheckbox.checked ? "none" : "inline";
        btnNormalize.style.display = iptCheckbox.checked ? "none" : "inline";
      });

      btnEdit.addEventListener("click", async () => {
        if (!cameraEnhancer.isOpen() || items.length <= 1) return;
        /* Stops the detection task since we assume we have found a good boundary. */
        router.stopCapturing();
        /* Hides the cameraView and shows the imageEditorView. */
        cameraViewContainer.style.display = "none";
        imageEditorViewContainer.style.display = "block";
        /* Draws the image on the imageEditorView first. */
        imageEditorView.setOriginalImage(image);
        quads = [];
        /* Draws the document boundary (quad) over the image. */
        for (let i = 0; i < items.length; i++) {
          if (
            items[i].type ===
            Dynamsoft.Core.EnumCapturedResultItemType.CRIT_ORIGINAL_IMAGE
          )
            continue;
          const points = items[i].location.points;
          const quad = new Dynamsoft.DCE.DrawingItem.QuadDrawingItem({
            points,
          });
          quads.push(quad);
          layer.addDrawingItems(quads);
        }
        btnStart.style.display = "none";
        btnRestart.style.display = "inline";
        btnNormalize.disabled = false;
        btnEdit.disabled = true;
      });

      btnNormalize.addEventListener("click", async () => {
        /* Hides the imageEditorView. */
        imageEditorViewContainer.style.display = "none";
        /* Removes the old normalized image if any. */
        normalizedImageContainer.innerHTML = "";
        /* Gets the selected quadrilateral. */
        let seletedItems = imageEditorView.getSelectedDrawingItems();
        let quad;
        if (seletedItems.length) {
          quad = seletedItems[0].getQuad();
        } else {
          quad = items[1].location;
        }
        /**
         * Sets the coordinates of the ROI (region of interest)
         * in the built-in template "normalize-document".
         */
        let newSettings = await router.getSimplifiedSettings(
          "normalize-document"
        );
        newSettings.roiMeasuredInPercentage = 0;
        newSettings.roi.points = quad.points;
        await router.updateSettings("normalize-document", newSettings);
        /* Executes the normalization and shows the result on the page. */
        let normalizeResult = await router.capture(image, "normalize-document");
        normalizedImageContainer.append(normalizeResult.items[0].toCanvas());
        layer.clearDrawingItems();
        /**
         * Resets the buttons and starts over.
         */
        btnStart.style.display = "inline";
        btnRestart.style.display = "none";
        btnNormalize.disabled = true;
        btnEdit.disabled = false;
        cameraViewContainer.style.display = "block";
        view.getUIElement().style.display = "";
        await router.startCapturing("detect-document-boundaries");
      });
    </script>
  </body>
</html>