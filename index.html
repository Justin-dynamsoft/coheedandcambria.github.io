<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sample-dlr-3.2.10</title>
    <script src="./dlr-3.2.10/core/core.js"></script>
    <script src="./dlr-3.2.10/utility/utility.js"></script>
    <script src="./dlr-3.2.10/license/license.js"></script>
    <script src="./dlr-3.2.10/dlr/dlr.js"></script>
    <script src="./dlr-3.2.10/cvr/cvr.js"></script>
</head>

<body>
    <input type="file">
    <script>
        Object.assign(Dynamsoft.Core.CoreModule.engineResourcePaths, {
            std: './dlr-3.2.10/std/',
            dip: './dlr-3.2.10/dip/',
            dnn: './dlr-3.2.10/dnn/',
            dlrData: './dlr-3.2.10/dlrData/'
        });

        Dynamsoft.Core.CoreModule.loadWasm(["DIP", "CVR", "DLR"]);

        let ipt = document.querySelector("input");
        let cvr;
        let contoursArrayLength = 0;

        let pCvrReady = (async () => {
            cvr = await Dynamsoft.CVR.CaptureVisionRouter.createInstance();
            const settings = {
                "CaptureVisionTemplates": [
                    {
                        "Name": "cv0",
                        "OutputOriginalImage": 1,
                        "ImageROIProcessingNameArray": [
                            "roi-detect-signature"//,
                            //"roi-recognize-labels"
                        ],
                        "Timeout": 10000
                    }
                ],
                "TargetROIDefOptions": [
                    {
                        "Name": "roi-recognize-labels",
                        "TaskSettingNameArray": [
                            "task-recognize-labels"
                        ]
                    },
                    {
                        "Name": "roi-detect-signature",
                        "TaskSettingNameArray": [
                            "task-detect-signature"
                        ],
                        "Location": {
                            "ReferenceObjectFilter": {
                                "ReferenceTargetROIDefNameArray": ["roi-recognize-labels"],
                                "TextLineFilteringCondition": {
                                    "LineStringRegExPattern": ".*Signature.*"
                                }
                            },
                            "Offset": {
                                "MeasuredByPercentage": 1,
                                "FirstPoint": [100, -120],
                                "SecondPoint": [300, -120],
                                "ThirdPoint": [300, 120],
                                "FourthPoint": [100, 120]
                            }
                        }
                    }
                ],
                "LabelRecognizerTaskSettingOptions": [
                    {
                        "Name": "task-detect-signature",
                        "TextLineSpecificationNameArray": [
                            "tls-textlines"
                        ],
                        "SectionImageParameterArray": [
                            {
                                "Section": "ST_REGION_PREDETECTION",
                                "ImageParameterName": "ip-recognize"
                            },
                            {
                                "Section": "ST_TEXT_LINE_LOCALIZATION",
                                "ImageParameterName": "ip-recognize"
                            },
                            {
                                "Section": "ST_TEXT_LINE_RECOGNITION",
                                "ImageParameterName": "ip-recognize"
                            }
                        ]
                    },
                    {
                        "Name": "task-recognize-labels",
                        "TextLineSpecificationNameArray": [
                            "tls-textlines"
                        ],
                        "StringLengthRange": [3, 10000],
                        "SectionImageParameterArray": [
                            {
                                "Section": "ST_REGION_PREDETECTION",
                                "ImageParameterName": "ip-recognize"
                            },
                            {
                                "Section": "ST_TEXT_LINE_LOCALIZATION",
                                "ImageParameterName": "ip-recognize"
                            },
                            {
                                "Section": "ST_TEXT_LINE_RECOGNITION",
                                "ImageParameterName": "ip-recognize"
                            }
                        ]
                    }
                ],
                "ImageParameterOptions": [
                    {
                        "Name": "ip-recognize",
                        "TextDetectionMode": {
                            "Mode": "TTDM_LINE",
                            "Direction": "HORIZONTAL",
                            "Sensitivity": 7
                        } //,
                        //"BinarizationModes": [
                        //  {
                        //    "Mode": "BM_LOCAL_BLOCK",
                        //    "BlockSizeX": 15,
                        //    "BlockSizeY": 15,
                        //    "EnableFillBinaryVacancy": 1
                        //  }
                        //]
                    }
                ],
                "CharacterModelOptions": [
                    {
                        "Name": "Letter"
                    }
                ],
                "TextLineSpecificationOptions": [
                    {
                        "Name": "tls-textlines",
                        "CharacterModelName": "Letter",
                        "OutputResults": 1,
                        "StringLengthRange": [3, 500],
                        "CharHeightRange": [
                            5,
                            1000,
                            1
                        ],
                        "BinarizationModes": [
                            {
                                "Mode": "BM_LOCAL_BLOCK",
                                "BlockSizeX": 11,
                                "BlockSizeY": 11,
                                "EnableFillBinaryVacancy": 1
                            }
                        ]
                    }
                ]
            };
            await cvr.initSettings(settings);

            let irr = new Dynamsoft.CVR.IntermediateResultReceiver();
            intermediateManager = cvr.getIntermediateResultManager();
            irr.onContoursUnitReceived = (result, info) => {
                if(info.taskName !== "task-detect-signature") {
                    return
                } else {
                    if (result.contours.length > contoursArrayLength){
                        contoursArrayLength = result.contours.length;
                    }
                    console.log(result, info);
                }
            }
            intermediateManager.addResultReceiver(irr);
        })();

        ipt.addEventListener("change", async (e) => {
            await pCvrReady;
            let file = e.target.files[0];
            let result = await cvr.capture(file, "cv0");
            // console.log(result.items);
            // let t = result.items.filter((item)=>{
            //     return item.text && item.text.includes("Signature");
            // })
            // console.log(t);
            if(contoursArrayLength > 10) {
                alert("signed")
            } else {
                alert("unsigned")
            }
            contoursArrayLength = 0;
        })
    </script>
</body>

</html>