<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sample-dlr-3.2.10</title>
    <script src="./dlr-3.2.10/core/core.js"></script>
    <!-- <script src="./dlr-3.2.10/utility/utility.js"></script> -->
    <script src="./dlr-3.2.10/license/license.js"></script>
    <script src="./dlr-3.2.10/dlr/dlr.js"></script>
    <script src="./dlr-3.2.10/cvr/cvr.js"></script>
    <script type="text/javascript" src="./dlr-3.2.10/dwt/Resources/dynamsoft.webtwain.initiate.js"></script>
    <script type="text/javascript" src="./dlr-3.2.10/dwt/Resources/dynamsoft.webtwain.config.js"></script>
</head>

<body>
    <input type="file" value = "Process" id ="dlrProcess" onclick="ProcessImage();" />
    <input type="button" value="Load" id="dwtProcess" onclick="LoadImage();" />

    <!-- dwtcontrolContainer is the default div id for Dynamic Web TWAIN control.
     If you need to rename the id, you should also change the id in dynamsoft.webtwain.config.js accordingly. -->
    <div id="dwtcontrolContainer" style="width: 350px; height: 380px;"></div>

    <script>

        var DWObject;
        function Dynamsoft_OnReady() {
            DWObject = Dynamsoft.DWT.GetWebTwain('dwtcontrolContainer'); // Get the Dynamic Web TWAIN object that is embeded in the div with id 'dwtcontrolContainer'
        }

        //Callback functions for async APIs
        function OnSuccess() {
            console.log('successful');
        }
        function OnFailure(errorCode, errorString) {
            if(errorCode != -2326)
			alert(errorString);
        }

        function LoadImage() {
            if (DWObject) {
                DWObject.IfShowFileDialog = true; // Open the system's file dialog to load image
                DWObject.LoadImageEx("", Dynamsoft.DWT.EnumDWT_ImageType.IT_ALL, OnSuccess, OnFailure); // Load images in all supported formats (.bmp, .jpg, .tif, .png, .pdf). OnSuccess or OnFailure will be called after the operation
            }
        }

        Object.assign(Dynamsoft.Core.CoreModule.engineResourcePaths, {
            std: './dlr-3.2.10/std/',
            dip: './dlr-3.2.10/dip/',
            dnn: './dlr-3.2.10/dnn/',
            dlrData: './dlr-3.2.10/dlrData/'
        });

        Dynamsoft.Core.CoreModule.loadWasm(["DIP", "CVR", "DLR"]);

        // initialize license key here. To initialize, uncomment the line below and replace the input parameter with your own trial key
        Dynamsoft.License.LicenseManager.initLicense("DLS2eyJoYW5kc2hha2VDb2RlIjoiMzE0NTQwLVRYbFhaV0pRY205cSIsIm1haW5TZXJ2ZXJVUkwiOiJodHRwczovL21sdHMuZHluYW1zb2Z0LmNvbSIsIm9yZ2FuaXphdGlvbklEIjoiMzE0NTQwIiwic3RhbmRieVNlcnZlclVSTCI6Imh0dHBzOi8vc2x0cy5keW5hbXNvZnQuY29tIiwiY2hlY2tDb2RlIjoxOTY5OTM3NTcyfQ==");

        //let ipt = document.querySelector("input");
        let blobResult;
        let cvr;
        let contoursArrayLength = 0;

        let pCvrReady = (async () => {
            cvr = await Dynamsoft.CVR.CaptureVisionRouter.createInstance();
            const settings = {
                "CaptureVisionTemplates": [
                    {
                        "Name": "cv0",
                        "OutputOriginalImage": 1,
                        "ImageROIProcessingNameArray": [
                            "roi-detect-signature"//,
                            //"roi-recognize-labels"
                        ],
                        "Timeout": 10000
                    }
                ],
                "TargetROIDefOptions": [
                    {
                        "Name": "roi-recognize-labels",
                        "TaskSettingNameArray": [
                            "task-recognize-labels"
                        ]
                    },
                    {
                        "Name": "roi-detect-signature",
                        "TaskSettingNameArray": [
                            "task-detect-signature"
                        ],
                        "Location": {
                            "ReferenceObjectFilter": {
                                "ReferenceTargetROIDefNameArray": ["roi-recognize-labels"],
                                "TextLineFilteringCondition": {
                                    "LineStringRegExPattern": ".*Signature.*"
                                }
                            },
                            "Offset": {
                                "MeasuredByPercentage": 1,
                                "FirstPoint": [100, -120],
                                "SecondPoint": [300, -120],
                                "ThirdPoint": [300, 120],
                                "FourthPoint": [100, 120]
                            }
                        }
                    }
                ],
                "LabelRecognizerTaskSettingOptions": [
                    {
                        "Name": "task-detect-signature",
                        "TextLineSpecificationNameArray": [
                            "tls-textlines"
                        ],
                        "SectionImageParameterArray": [
                            {
                                "Section": "ST_REGION_PREDETECTION",
                                "ImageParameterName": "ip-recognize"
                            },
                            {
                                "Section": "ST_TEXT_LINE_LOCALIZATION",
                                "ImageParameterName": "ip-recognize"
                            },
                            {
                                "Section": "ST_TEXT_LINE_RECOGNITION",
                                "ImageParameterName": "ip-recognize"
                            }
                        ]
                    },
                    {
                        "Name": "task-recognize-labels",
                        "TextLineSpecificationNameArray": [
                            "tls-textlines"
                        ],
                        "StringLengthRange": [3, 10000],
                        "SectionImageParameterArray": [
                            {
                                "Section": "ST_REGION_PREDETECTION",
                                "ImageParameterName": "ip-recognize"
                            },
                            {
                                "Section": "ST_TEXT_LINE_LOCALIZATION",
                                "ImageParameterName": "ip-recognize"
                            },
                            {
                                "Section": "ST_TEXT_LINE_RECOGNITION",
                                "ImageParameterName": "ip-recognize"
                            }
                        ]
                    }
                ],
                "ImageParameterOptions": [
                    {
                        "Name": "ip-recognize",
                        "TextDetectionMode": {
                            "Mode": "TTDM_LINE",
                            "Direction": "HORIZONTAL",
                            "Sensitivity": 7
                        } //,
                        //"BinarizationModes": [
                        //  {
                        //    "Mode": "BM_LOCAL_BLOCK",
                        //    "BlockSizeX": 15,
                        //    "BlockSizeY": 15,
                        //    "EnableFillBinaryVacancy": 1
                        //  }
                        //]
                    }
                ],
                "CharacterModelOptions": [
                    {
                        "Name": "Letter"
                    }
                ],
                "TextLineSpecificationOptions": [
                    {
                        "Name": "tls-textlines",
                        "CharacterModelName": "Letter",
                        "OutputResults": 1,
                        "StringLengthRange": [3, 500],
                        "CharHeightRange": [
                            5,
                            1000,
                            1
                        ],
                        "BinarizationModes": [
                            {
                                "Mode": "BM_LOCAL_BLOCK",
                                "BlockSizeX": 11,
                                "BlockSizeY": 11,
                                "EnableFillBinaryVacancy": 1
                            }
                        ]
                    }
                ]
            };
            await cvr.initSettings(settings);

            let irr = new Dynamsoft.CVR.IntermediateResultReceiver();
            intermediateManager = cvr.getIntermediateResultManager();
            irr.onContoursUnitReceived = (result, info) => {
                if(info.taskName !== "task-detect-signature") {
                    return
                } else {
                    if (result.contours.length > contoursArrayLength){
                        contoursArrayLength = result.contours.length;
                    }
                    console.log(result, info);
                }
            }
            intermediateManager.addResultReceiver(irr);
        })();

        /*ipt.addEventListener("change", async (e) => {
            await pCvrReady;
            let file = e.target.files[0];
            let result = await cvr.capture(file, "cv0");
            // console.log(result.items);
            // let t = result.items.filter((item)=>{
            //     return item.text && item.text.includes("Signature");
            // })
            // console.log(t);
            if(contoursArrayLength > 10) {
                alert("signed")
            } else {
                alert("unsigned")
            }
            contoursArrayLength = 0;
        })*/

        function LoadImage() {
            if (DWObject) {
                DWObject.IfShowFileDialog = true; // Open the system's file dialog to load image
                DWObject.LoadImageEx("", Dynamsoft.DWT.EnumDWT_ImageType.IT_ALL, OnSuccess, OnFailure); // Load images in all supported formats (.bmp, .jpg, .tif, .png, .pdf). OnSuccess or OnFailure will be called after the operation
            }
        }

        async function ProcessImage() {
            await pCvrReady;
            if(DWObject) {
                if(DWObject.HowManyImagesInBuffer > 0){
                    // convert the latest image in the buffer to a blob
                    // if working with a multi-page PDF and uncertain on which page the signature is on, then you will need to loop through the images that are added to the buffer.
                    // once the PDF is loaded into the DWT buffer, they are turned into images, so when converting to a blob, the IT_JPG format needs to be selected because PDF will not work with DLR JS
                    // 
                    DWObject.ConvertToBlob(
                        [DWObject.CurrentImageIndexInBuffer],
                        Dynamsoft.DWT.EnumDWT_ImageType.IT_JPG,
                        function (result, indices, type) {
                            console.log(result.size);
                            blobResult = result;
                        },
                        function (errorCode, errorString) {
                            console.log(errorString);
                        }
                    );

                    // now that the blob is in the dlrResult, let's process it
                    let dlrResult = await cvr.capture(blobResult, "cv0");
                    if(contoursArrayLength > 10) {
                        alert("signed")
                    } else {
                        alert("unsigned")
                    }
                    contoursArrayLength = 0;
                }
            }
        }

    </script>
</body>

</html>