/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Utility JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2024, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 1.2.20
 * @fileoverview Dynamsoft JavaScript Library for Utility
 * More info DU JS: https://www.dynamsoft.com/capture-vision/docs/web/programming/javascript/api-reference/utility/utility-module.html
 */
import{EnumImagePixelFormat as e,requestResource as t,getNextTaskID as i,mapTaskCallBack as r,worker as n,engineResourcePaths as s,workerAutoResources as a,compareVersion as l,innerVersions as o,EnumCapturedResultItemType as d}from"dynamsoft-core";const c=async(e,t,i)=>await new Promise((async(r,n)=>{try{const n=t.split(".");let s=n[n.length-1];const a=await f(`image/${s}`,e);n.length<=1&&(s="png");const l=new File([a],t,{type:`image/${s}`});if(i){const e=URL.createObjectURL(l),i=document.createElement("a");i.href=e,i.download=t,i.click()}return r(l)}catch(e){return n()}})),u=e=>{const t=document.createElement("canvas");t.width=e.width,t.height=e.height;return t.getContext("2d",{willReadFrequently:!0}).putImageData(e,0,0),t},E=(e,t)=>{const i=u(t);let r=new Image,n=i.toDataURL(e);return r.src=n,r},f=async(e,t)=>{const i=u(t);return new Promise(((t,r)=>{i.toBlob((e=>t(e)),e)}))},h=t=>{let i,r=t.bytes;if(!(r&&r instanceof Uint8Array))throw Error("Parameter type error");if(Number(t.format)===e.IPF_BGR_888){const e=r.length/3;i=new Uint8ClampedArray(4*e);for(let t=0;t<e;++t)i[4*t]=r[3*t],i[4*t+1]=r[3*t+1],i[4*t+2]=r[3*t+2],i[4*t+3]=255}else if(Number(t.format)===e.IPF_RGB_888){const e=r.length/3;i=new Uint8ClampedArray(4*e);for(let t=0;t<e;++t)i[4*t]=r[3*t+2],i[4*t+1]=r[3*t+1],i[4*t+2]=r[3*t],i[4*t+3]=255}else if(Number(t.format)===e.IPF_GRAYSCALED){const e=r.length;i=new Uint8ClampedArray(4*e);for(let t=0;t<e;t++)i[4*t]=i[4*t+1]=i[4*t+2]=r[t],i[4*t+3]=255}else if(Number(t.format)===e.IPF_BINARY_8){const e=r.length,n=t.width,s=t.height,a=t.stride;i=new Uint8ClampedArray(n*s*4);for(let t=0;t<e;t++){let e=r[t],s=t%a,l=Math.floor(t/a);for(let t=0;t<8;t++){let r=s+t,a=4*(l*n+r);if(r>=n)break;i[a]=i[a+1]=i[a+2]=(128&e)/128*255,i[a+3]=255,e<<=1}}}else if(Number(t.format)===e.IPF_ABGR_8888){const e=r.length/4;i=new Uint8ClampedArray(r.length);for(let t=0;t<e;++t)i[4*t]=r[4*t],i[4*t+1]=r[4*t+1],i[4*t+2]=r[4*t+2],i[4*t+3]=r[4*t+3]}else if(Number(t.format)===e.IPF_ARGB_8888){const e=r.length/4;i=new Uint8ClampedArray(r.length);for(let t=0;t<e;++t)i[4*t]=r[4*t],i[4*t+1]=r[4*t+1],i[4*t+2]=r[4*t+2],i[4*t+3]=r[4*t+3]}return new ImageData(i,t.width,t.height)},R=async e=>{let t;await new Promise(((i,r)=>{t=new Image,t.onload=()=>i(t),t.onerror=r,t.src=URL.createObjectURL(e)}));const i=document.createElement("canvas"),r=i.getContext("2d");i.width=t.width,i.height=t.height,r.drawImage(t,0,0);return{bytes:Uint8Array.from(r.getImageData(0,0,i.width,i.height).data),width:i.width,height:i.height,stride:4*i.width,format:10}};class g{async saveToFile(e,t,i){if(!e||!t)return null;if("string"!=typeof t)throw new TypeError("FileName must be of type string.");const r=h(e);return c(r,t,i)}async drawOnImage(e,s,a,l=4294901760,o=1,d){let c;if(e instanceof Blob)c=await R(e);else if("string"==typeof e){let i=await t(e,"blob");c=await R(i)}return await new Promise(((e,t)=>{let u=i();r[u]=async i=>{if(i.success)return d&&this.saveToFile(i.image,"test.png",d),e(i.image);{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}},n.postMessage({type:"utility_drawOnImage",id:u,body:{dsImage:c,drawingItem:s instanceof Array?s:[s],color:l,thickness:o,type:a}})}))}}const I="undefined"==typeof self,T=(()=>{if(!I&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})(),m=e=>{if(null==e&&(e="./"),I);else{let t=document.createElement("a");t.href=e,e=t.href}return e.endsWith("/")||(e+="/"),e};null==s.utility&&(s.utility=T),a.utility={js:!0,wasm:!0};const _="1.2.10";"string"!=typeof s.std&&l(s.std.version,_)<0&&(s.std={version:_,path:m(T+`../../dynamsoft-capture-vision-std@${_}/dist/`)});const p="2.2.30";(!s.dip||"string"!=typeof s.dip&&l(s.dip.version,p)<0)&&(s.dip={version:p,path:m(T+`../../dynamsoft-image-processing@${p}/dist/`)});class C{static getVersion(){return`1.2.20(Worker: ${o.utility&&o.utility.worker||"Not Loaded"}, Wasm: ${o.utility&&o.utility.wasm||"Not Loaded"})`}}const y={barcode:2,text_line:4,detected_quad:8,normalized_image:16},D=e=>Object.values(y).includes(e)||y.hasOwnProperty(e),w=(e,t)=>"string"==typeof e?t[y[e]]:t[e],A=(e,t,i)=>{"string"==typeof e?t[y[e]]=i:t[e]=i};class b{constructor(){this.verificationEnabled={[d.CRIT_BARCODE]:!1,[d.CRIT_TEXT_LINE]:!0,[d.CRIT_DETECTED_QUAD]:!0,[d.CRIT_NORMALIZED_IMAGE]:!1},this.duplicateFilterEnabled={[d.CRIT_BARCODE]:!1,[d.CRIT_TEXT_LINE]:!1,[d.CRIT_DETECTED_QUAD]:!1,[d.CRIT_NORMALIZED_IMAGE]:!1},this.duplicateForgetTime={[d.CRIT_BARCODE]:3e3,[d.CRIT_TEXT_LINE]:3e3,[d.CRIT_DETECTED_QUAD]:3e3,[d.CRIT_NORMALIZED_IMAGE]:3e3}}enableResultCrossVerification(e,t){D(e)&&A(e,this.verificationEnabled,t)}isResultCrossVerificationEnabled(e){return!!D(e)&&w(e,this.verificationEnabled)}enableResultDeduplication(e,t){D(e)&&A(e,this.duplicateFilterEnabled,t)}isResultDeduplicationEnabled(e){return!!D(e)&&w(e,this.duplicateFilterEnabled)}setDuplicateForgetTime(e,t){D(e)&&(t>18e4&&(t=18e4),t<0&&(t=0),A(e,this.duplicateForgetTime,t))}getDuplicateForgetTime(e){return D(e)?w(e,this.duplicateForgetTime):-1}getFilteredResultItemTypes(){let e=0;const t=[d.CRIT_BARCODE,d.CRIT_TEXT_LINE,d.CRIT_DETECTED_QUAD];for(let i=0;i<t.length;i++)(this.verificationEnabled[t[i]]||this.duplicateFilterEnabled[t[i]])&&(e|=t[i]);return e}onOriginalImageResultReceived(e){}onDecodedBarcodesReceived(e){if(this.isResultCrossVerificationEnabled(d.CRIT_BARCODE))for(let t=0;t<e.length;t++)e[t]&&e[t].type===d.CRIT_BARCODE&&!e[t].verified&&(e[t].isFilter=!0);if(this.isResultDeduplicationEnabled(d.CRIT_BARCODE))for(let t=0;t<e.length;t++)e[t]&&e[t].type===d.CRIT_BARCODE&&e[t].duplicate&&(e[t].isFilter=!0)}onRecognizedTextLinesReceived(e){if(this.isResultCrossVerificationEnabled(d.CRIT_TEXT_LINE))for(let t=0;t<e.length;t++)e[t]&&e[t].type===d.CRIT_TEXT_LINE&&!e[t].verified&&(e[t].isFilter=!0);if(this.isResultDeduplicationEnabled(d.CRIT_TEXT_LINE))for(let t=0;t<e.length;t++)e[t]&&e[t].type===d.CRIT_TEXT_LINE&&e[t].duplicate&&(e[t].isFilter=!0)}onDetectedQuadsReceived(e){if(this.isResultCrossVerificationEnabled(d.CRIT_DETECTED_QUAD))for(let t=0;t<e.length;t++)e[t]&&e[t].type===d.CRIT_DETECTED_QUAD&&!e[t].verified&&(e[t].isFilter=!0);if(this.isResultDeduplicationEnabled(d.CRIT_DETECTED_QUAD))for(let t=0;t<e.length;t++)e[t]&&e[t].type===d.CRIT_DETECTED_QUAD&&e[t].duplicate&&(e[t].isFilter=!0)}onNormalizedImagesReceived(e){if(this.isResultCrossVerificationEnabled(d.CRIT_NORMALIZED_IMAGE))for(let t=0;t<e.length;t++)e[t]&&e[t].type===d.CRIT_NORMALIZED_IMAGE&&!e[t].verified&&(e[t].isFilter=!0);if(this.isResultDeduplicationEnabled(d.CRIT_NORMALIZED_IMAGE))for(let t=0;t<e.length;t++)e[t]&&e[t].type===d.CRIT_NORMALIZED_IMAGE&&e[t].duplicate&&(e[t].isFilter=!0)}}export{g as ImageManager,b as MultiFrameResultCrossFilter,C as UtilityModule,h as _getNorImageData,c as _saveToFile,f as _toBlob,u as _toCanvas,E as _toImage};
