/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Utility JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2024, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 1.2.20
 * @fileoverview Dynamsoft JavaScript Library for Utility
 * More info DU JS: https://www.dynamsoft.com/capture-vision/docs/web/programming/javascript/api-reference/utility/utility-module.html
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("dynamsoft-core")):"function"==typeof define&&define.amd?define(["exports","dynamsoft-core"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).Dynamsoft=e.Dynamsoft||{},e.Dynamsoft.Utility={}),e.Dynamsoft.Core)}(this,(function(e,t){"use strict";const i=async(e,t,i)=>await new Promise((async(n,s)=>{try{const s=t.split(".");let a=s[s.length-1];const l=await r(`image/${a}`,e);s.length<=1&&(a="png");const u=new File([l],t,{type:`image/${a}`});if(i){const e=URL.createObjectURL(u),i=document.createElement("a");i.href=e,i.download=t,i.click()}return n(u)}catch(e){return s()}})),n=e=>{const t=document.createElement("canvas");t.width=e.width,t.height=e.height;return t.getContext("2d",{willReadFrequently:!0}).putImageData(e,0,0),t},r=async(e,t)=>{const i=n(t);return new Promise(((t,n)=>{i.toBlob((e=>t(e)),e)}))},s=e=>{let i,n=e.bytes;if(!(n&&n instanceof Uint8Array))throw Error("Parameter type error");if(Number(e.format)===t.EnumImagePixelFormat.IPF_BGR_888){const e=n.length/3;i=new Uint8ClampedArray(4*e);for(let t=0;t<e;++t)i[4*t]=n[3*t],i[4*t+1]=n[3*t+1],i[4*t+2]=n[3*t+2],i[4*t+3]=255}else if(Number(e.format)===t.EnumImagePixelFormat.IPF_RGB_888){const e=n.length/3;i=new Uint8ClampedArray(4*e);for(let t=0;t<e;++t)i[4*t]=n[3*t+2],i[4*t+1]=n[3*t+1],i[4*t+2]=n[3*t],i[4*t+3]=255}else if(Number(e.format)===t.EnumImagePixelFormat.IPF_GRAYSCALED){const e=n.length;i=new Uint8ClampedArray(4*e);for(let t=0;t<e;t++)i[4*t]=i[4*t+1]=i[4*t+2]=n[t],i[4*t+3]=255}else if(Number(e.format)===t.EnumImagePixelFormat.IPF_BINARY_8){const t=n.length,r=e.width,s=e.height,a=e.stride;i=new Uint8ClampedArray(r*s*4);for(let e=0;e<t;e++){let t=n[e],s=e%a,l=Math.floor(e/a);for(let e=0;e<8;e++){let n=s+e,a=4*(l*r+n);if(n>=r)break;i[a]=i[a+1]=i[a+2]=(128&t)/128*255,i[a+3]=255,t<<=1}}}else if(Number(e.format)===t.EnumImagePixelFormat.IPF_ABGR_8888){const e=n.length/4;i=new Uint8ClampedArray(n.length);for(let t=0;t<e;++t)i[4*t]=n[4*t],i[4*t+1]=n[4*t+1],i[4*t+2]=n[4*t+2],i[4*t+3]=n[4*t+3]}else if(Number(e.format)===t.EnumImagePixelFormat.IPF_ARGB_8888){const e=n.length/4;i=new Uint8ClampedArray(n.length);for(let t=0;t<e;++t)i[4*t]=n[4*t],i[4*t+1]=n[4*t+1],i[4*t+2]=n[4*t+2],i[4*t+3]=n[4*t+3]}return new ImageData(i,e.width,e.height)},a=async e=>{let t;await new Promise(((i,n)=>{t=new Image,t.onload=()=>i(t),t.onerror=n,t.src=URL.createObjectURL(e)}));const i=document.createElement("canvas"),n=i.getContext("2d");i.width=t.width,i.height=t.height,n.drawImage(t,0,0);return{bytes:Uint8Array.from(n.getImageData(0,0,i.width,i.height).data),width:i.width,height:i.height,stride:4*i.width,format:10}};const l="undefined"==typeof self,u=(()=>{if(!l&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})(),o=e=>{if(null==e&&(e="./"),l);else{let t=document.createElement("a");t.href=e,e=t.href}return e.endsWith("/")||(e+="/"),e};null==t.engineResourcePaths.utility&&(t.engineResourcePaths.utility=u),t.workerAutoResources.utility={js:!0,wasm:!0};const m="1.2.10";"string"!=typeof t.engineResourcePaths.std&&t.compareVersion(t.engineResourcePaths.std.version,m)<0&&(t.engineResourcePaths.std={version:m,path:o(u+`../../dynamsoft-capture-vision-std@${m}/dist/`)});const d="2.2.30";(!t.engineResourcePaths.dip||"string"!=typeof t.engineResourcePaths.dip&&t.compareVersion(t.engineResourcePaths.dip.version,d)<0)&&(t.engineResourcePaths.dip={version:d,path:o(u+`../../dynamsoft-image-processing@${d}/dist/`)});const c={barcode:2,text_line:4,detected_quad:8,normalized_image:16},p=e=>Object.values(c).includes(e)||c.hasOwnProperty(e),E=(e,t)=>"string"==typeof e?t[c[e]]:t[e],R=(e,t,i)=>{"string"==typeof e?t[c[e]]=i:t[e]=i};e.ImageManager=class{async saveToFile(e,t,n){if(!e||!t)return null;if("string"!=typeof t)throw new TypeError("FileName must be of type string.");const r=s(e);return i(r,t,n)}async drawOnImage(e,i,n,r=4294901760,s=1,l){let u;if(e instanceof Blob)u=await a(e);else if("string"==typeof e){let i=await t.requestResource(e,"blob");u=await a(i)}return await new Promise(((e,a)=>{let o=t.getNextTaskID();t.mapTaskCallBack[o]=async t=>{if(t.success)return l&&this.saveToFile(t.image,"test.png",l),e(t.image);{let e=new Error(t.message);return e.stack=t.stack+"\n"+e.stack,a(e)}},t.worker.postMessage({type:"utility_drawOnImage",id:o,body:{dsImage:u,drawingItem:i instanceof Array?i:[i],color:r,thickness:s,type:n}})}))}},e.MultiFrameResultCrossFilter=class{constructor(){this.verificationEnabled={[t.EnumCapturedResultItemType.CRIT_BARCODE]:!1,[t.EnumCapturedResultItemType.CRIT_TEXT_LINE]:!0,[t.EnumCapturedResultItemType.CRIT_DETECTED_QUAD]:!0,[t.EnumCapturedResultItemType.CRIT_NORMALIZED_IMAGE]:!1},this.duplicateFilterEnabled={[t.EnumCapturedResultItemType.CRIT_BARCODE]:!1,[t.EnumCapturedResultItemType.CRIT_TEXT_LINE]:!1,[t.EnumCapturedResultItemType.CRIT_DETECTED_QUAD]:!1,[t.EnumCapturedResultItemType.CRIT_NORMALIZED_IMAGE]:!1},this.duplicateForgetTime={[t.EnumCapturedResultItemType.CRIT_BARCODE]:3e3,[t.EnumCapturedResultItemType.CRIT_TEXT_LINE]:3e3,[t.EnumCapturedResultItemType.CRIT_DETECTED_QUAD]:3e3,[t.EnumCapturedResultItemType.CRIT_NORMALIZED_IMAGE]:3e3}}enableResultCrossVerification(e,t){p(e)&&R(e,this.verificationEnabled,t)}isResultCrossVerificationEnabled(e){return!!p(e)&&E(e,this.verificationEnabled)}enableResultDeduplication(e,t){p(e)&&R(e,this.duplicateFilterEnabled,t)}isResultDeduplicationEnabled(e){return!!p(e)&&E(e,this.duplicateFilterEnabled)}setDuplicateForgetTime(e,t){p(e)&&(t>18e4&&(t=18e4),t<0&&(t=0),R(e,this.duplicateForgetTime,t))}getDuplicateForgetTime(e){return p(e)?E(e,this.duplicateForgetTime):-1}getFilteredResultItemTypes(){let e=0;const i=[t.EnumCapturedResultItemType.CRIT_BARCODE,t.EnumCapturedResultItemType.CRIT_TEXT_LINE,t.EnumCapturedResultItemType.CRIT_DETECTED_QUAD];for(let t=0;t<i.length;t++)(this.verificationEnabled[i[t]]||this.duplicateFilterEnabled[i[t]])&&(e|=i[t]);return e}onOriginalImageResultReceived(e){}onDecodedBarcodesReceived(e){if(this.isResultCrossVerificationEnabled(t.EnumCapturedResultItemType.CRIT_BARCODE))for(let i=0;i<e.length;i++)e[i]&&e[i].type===t.EnumCapturedResultItemType.CRIT_BARCODE&&!e[i].verified&&(e[i].isFilter=!0);if(this.isResultDeduplicationEnabled(t.EnumCapturedResultItemType.CRIT_BARCODE))for(let i=0;i<e.length;i++)e[i]&&e[i].type===t.EnumCapturedResultItemType.CRIT_BARCODE&&e[i].duplicate&&(e[i].isFilter=!0)}onRecognizedTextLinesReceived(e){if(this.isResultCrossVerificationEnabled(t.EnumCapturedResultItemType.CRIT_TEXT_LINE))for(let i=0;i<e.length;i++)e[i]&&e[i].type===t.EnumCapturedResultItemType.CRIT_TEXT_LINE&&!e[i].verified&&(e[i].isFilter=!0);if(this.isResultDeduplicationEnabled(t.EnumCapturedResultItemType.CRIT_TEXT_LINE))for(let i=0;i<e.length;i++)e[i]&&e[i].type===t.EnumCapturedResultItemType.CRIT_TEXT_LINE&&e[i].duplicate&&(e[i].isFilter=!0)}onDetectedQuadsReceived(e){if(this.isResultCrossVerificationEnabled(t.EnumCapturedResultItemType.CRIT_DETECTED_QUAD))for(let i=0;i<e.length;i++)e[i]&&e[i].type===t.EnumCapturedResultItemType.CRIT_DETECTED_QUAD&&!e[i].verified&&(e[i].isFilter=!0);if(this.isResultDeduplicationEnabled(t.EnumCapturedResultItemType.CRIT_DETECTED_QUAD))for(let i=0;i<e.length;i++)e[i]&&e[i].type===t.EnumCapturedResultItemType.CRIT_DETECTED_QUAD&&e[i].duplicate&&(e[i].isFilter=!0)}onNormalizedImagesReceived(e){if(this.isResultCrossVerificationEnabled(t.EnumCapturedResultItemType.CRIT_NORMALIZED_IMAGE))for(let i=0;i<e.length;i++)e[i]&&e[i].type===t.EnumCapturedResultItemType.CRIT_NORMALIZED_IMAGE&&!e[i].verified&&(e[i].isFilter=!0);if(this.isResultDeduplicationEnabled(t.EnumCapturedResultItemType.CRIT_NORMALIZED_IMAGE))for(let i=0;i<e.length;i++)e[i]&&e[i].type===t.EnumCapturedResultItemType.CRIT_NORMALIZED_IMAGE&&e[i].duplicate&&(e[i].isFilter=!0)}},e.UtilityModule=class{static getVersion(){return`1.2.20(Worker: ${t.innerVersions.utility&&t.innerVersions.utility.worker||"Not Loaded"}, Wasm: ${t.innerVersions.utility&&t.innerVersions.utility.wasm||"Not Loaded"})`}},e._getNorImageData=s,e._saveToFile=i,e._toBlob=r,e._toCanvas=n,e._toImage=(e,t)=>{const i=n(t);let r=new Image,s=i.toDataURL(e);return r.src=s,r}}));
